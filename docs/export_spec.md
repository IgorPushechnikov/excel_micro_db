# Спецификация экспорта Excel Micro DB

## Общее описание

Этот документ описывает процесс экспорта проекта Excel Micro DB обратно в формат `.xlsx`. Цель экспорта — воссоздать Excel-файл, идентичный исходному (или максимально близкий к нему), на основе данных, хранящихся в локальной базе данных проекта (`project_data.db`).

## Архитектура экспорта

Процесс экспорта разделён на две основные части:

1.  **Подготовка данных (Python):**
    *   **Компонент:** `GoExporterBridge` (`src/exporter/go_bridge/go_exporter_bridge.py`).
    *   **Функция:** Сбор данных из `ProjectDBStorage`. Преобразование данных из внутреннего формата БД (в частности, стилей из формата `openpyxl`) в формат, описанный в [спецификации JSON для Go-экспортера](../spec/go_excel_exporter_input_spec.yaml).
    *   **Результат:** Валидированный объект Pydantic `ExportData`, который сериализуется в JSON-файл.

2.  **Генерация файла (Go):**
    *   **Компонент:** `go_excel_exporter.exe` (`src/exporter/go/main.go`).
    *   **Функция:** Чтение JSON-файла, сгенерированного Python-частью. Использование библиотеки `excelize` для создания и заполнения `.xlsx` файла.
    *   **Результат:** Итоговый `.xlsx` файл.

## Цель Go-экспортера

Цель Go-экспортера (`go_excel_exporter`) — обеспечить **быструю и надёжную** генерацию `.xlsx` файлов на основе подготовленных данных. Он должен уметь обрабатывать:
*   Данные ячеек (значения).
*   Формулы.
*   Стили ячеек (шрифты, заливка, границы, выравнивание).
*   Объединённые ячейки.
*   Диаграммы.

## Формат данных (Контракт)

Формат JSON, передаваемого от Python-части к Go-части, строго определён в файле спецификации: [spec/go_excel_exporter_input_spec.yaml](../spec/go_excel_exporter_input_spec.yaml). Этот файл служит "договором" между двумя частями системы.

## "Переводчик" структур стиля

Внутренний формат хранения стилей в БД (`openpyxl`) может отличаться от формата, ожидаемого библиотекой `excelize` в Go. Для обеспечения корректного преобразования используется модуль "переводчика":

*   **Файл:** `src/exporter/go_bridge/style_converter.py`
*   **Функция:** Рекурсивный обход и "очистка" словаря стиля, полученного из БД, от недопустимых строк-объектов (например, `"<openpyxl.styles.colors.Color object>..."`). Преобразование атрибутов стиля (`theme`, `tint`, `indexed` и т.д.) в конкретные значения (`rgb`, `style` и т.д.), понятные `excelize`.
*   **Цель:** Обеспечить, чтобы Go-экспортер получал данные в формате, который `excelize` может напрямую использовать для воссоздания всех аспектов стиля, сохранённых в БД.

## Тестирование

Интеграционный тест (`scripts/run_integration_test.py`) запускает полный цикл: инициализация -> анализ -> экспорт (включая Go-экспорт). Результаты Go- и Python-экспортёров сравниваются с исходным файлом для проверки корректности.
